<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Partikel Interaktif</title>
    
    <link rel="stylesheet" href="style.css">

    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
</head>
<body>

    <div id="kotak-error">
        <h3>CAMERA ERROR</h3>
        <p id="pesan-error">Checking camera...</p>
        <p style="font-size: 12px; margin-top: 10px;">Solution: Use VS Code "Live Server" or upload to CodePen/GitHub.</p>
    </div>

    <div id="instruksi">
        <div><span class="sorot">RIGHT HAND (Master):</span></div>
        <div>2 FINGERS (Pinch) = <b>GATHER / SCATTER</b></div>
        <div>5 FINGERS / FIST = <b>SPIN & TILT</b></div>
        <br>
        <div><span class="sorot">LEFT HAND (Shapes):</span></div>
        <div>1 Finger = Sphere | 2 Fingers = Heart</div>
        <div>3 Fingers = Galaxy | 4 Fingers = Black Hole</div>
        <div>5 Fingers = Nebula</div>
        <div id="teks-status" style="color:#aaa; font-size:11px; margin-top:5px;">Waiting for hands...</div>
    </div>
    <div id="wadah-pratinjau"><canvas id="kanvas_output"></canvas></div>
    <video id="video_input" playsinline></video>

    <div id="panel-ui">
        <div class="baris">
            <button class="tombol aktif" id="tombol-bola" onclick="aturBentuk('bola')">Sphere</button>
            <button class="tombol" id="tombol-hati" onclick="aturBentuk('hati')">Heart</button>
            <button class="tombol" id="tombol-galaksi" onclick="aturBentuk('galaksi')">Galaxy</button>
            <button class="tombol" id="tombol-lubanghitam" onclick="aturBentuk('lubanghitam')">Black Hole</button>
            <button class="tombol" id="tombol-nebula" onclick="aturBentuk('nebula')">Nebula</button>
        </div>
        <div class="baris">
            <input type="text" id="inputTeks" placeholder="NAME">
            <button class="tombol" onclick="teksKePartikel()" style="flex-grow:0;">TEXT</button>
        </div>
        <div class="baris">
            <button class="tombol" id="tombolMic" onclick="aktifkanAudio()" style="flex-grow:0;">AUDIO</button>
            <div style="width:1px; height:20px; background:#333; margin:0 5px;"></div>
            <div class="grup-slider"><span class="label">FRICTION</span><input type="range" id="sliderGesekan" min="0.90" max="0.99" step="0.001" value="0.98"></div>
            <div class="grup-slider"><span class="label">GLOW</span><input type="range" id="sliderCahaya" min="0" max="3" step="0.1" value="1.5"></div>
            <div class="grup-slider"><span class="label">ZOOM</span><input type="range" id="sliderZum" min="0.5" max="3.0" step="0.1" value="1.0"></div>
            <div style="width:1px; height:20px; background:#333; margin:0 5px;"></div>
            <input type="color" id="warna1" value="#ff8800"><input type="color" id="warna2" value="#000000">
        </div>
    </div>

    <script type="x-shader/x-vertex" id="vertexShader">
        uniform float uWaktu; 
        uniform float uGestur; 
        uniform float uUkuran;
        uniform float uDenyut; 
        uniform float uMorfosis; 
        attribute vec3 aPosisiAwal; 
        attribute vec3 aPosisiTujuan; 
        attribute vec3 aAcak; 
        varying float vAlpha; 
        varying vec3 vPos;
        void main() {
            float t = uGestur; 
            vec3 tersebar = aAcak * 70.0;
            tersebar.x += sin(uWaktu * 0.5 + aAcak.y) * 4.0;
            tersebar.y += cos(uWaktu * 0.3 + aAcak.x) * 4.0;
            vec3 terbentuk = mix(aPosisiAwal, aPosisiTujuan, uMorfosis);
            float efekDenyut = 1.0 + (uDenyut * 0.2); 
            terbentuk *= efekDenyut;
            vec3 posisiAkhir = mix(tersebar, terbentuk, t);
            vPos = posisiAkhir; 
            vec4 posisiMV = modelViewMatrix * vec4(posisiAkhir, 1.0);
            float ukuranDenyut = uUkuran * (1.0 + uDenyut * 2.0);
            gl_PointSize = (ukuranDenyut * 150.0) / -posisiMV.z;
            gl_Position = projectionMatrix * posisiMV;
            vAlpha = 0.3 + (0.7 * t);
        }
    </script>

    <script type="x-shader/x-fragment" id="fragmentShader">
        uniform vec3 uWarna1; 
        uniform vec3 uWarna2;
        varying float vAlpha; 
        varying vec3 vPos;
        void main() {
            float d = distance(gl_PointCoord, vec2(0.5));
            if (d > 0.5) discard;
            float panjang = length(vPos);
            float nilaiCampur = smoothstep(0.0, 25.0, panjang);
            if(abs(vPos.y) < 2.0 && panjang < 20.0) nilaiCampur *= 0.5; 
            vec3 warnaAkhir = mix(uWarna1, uWarna2, nilaiCampur);
            float inti = 1.0 - (d * 2.0);
            inti = pow(inti, 2.0); 
            gl_FragColor = vec4(warnaAkhir, vAlpha * inti);
        }
    </script>

    <script src="script.js"></script>
</body>
</html>